<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>dpki-ultralite/util.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Keypair.html">Keypair</a><ul class='methods'><li data-type='method'><a href="Keypair.html#.fromBundle">fromBundle</a></li><li data-type='method'><a href="Keypair.html#.newFromSeed">newFromSeed</a></li><li data-type='method'><a href="Keypair.html#decrypt">decrypt</a></li><li data-type='method'><a href="Keypair.html#encrypt">encrypt</a></li><li data-type='method'><a href="Keypair.html#getBundle">getBundle</a></li><li data-type='method'><a href="Keypair.html#getId">getId</a></li><li data-type='method'><a href="Keypair.html#sign">sign</a></li><li data-type='method'><a href="Keypair.html#verify">verify</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-dpki-ultralite.html">dpki-ultralite</a></li><li><a href="module-hClient.html">hClient</a><ul class='methods'><li data-type='method'><a href="module-hClient.html#.getCurrentAgentId">getCurrentAgentId</a></li><li data-type='method'><a href="module-hClient.html#.getDnaForUrl">getDnaForUrl</a></li><li data-type='method'><a href="module-hClient.html#.getHostsForUrl">getHostsForUrl</a></li><li data-type='method'><a href="module-hClient.html#.installLoginDialog">installLoginDialog</a></li><li data-type='method'><a href="module-hClient.html#.makeWebClient">makeWebClient</a></li><li data-type='method'><a href="module-hClient.html#.requestHosting">requestHosting</a></li><li data-type='method'><a href="module-hClient.html#.triggerLoginPrompt">triggerLoginPrompt</a></li></ul></li><li><a href="module-login.html">login</a><ul class='methods'><li data-type='method'><a href="module-login.html#~insertLoginHtml">insertLoginHtml</a></li><li data-type='method'><a href="module-login.html#~registerLoginCallbacks">registerLoginCallbacks</a></li><li data-type='method'><a href="module-login.html#~showLoginDialog">showLoginDialog</a></li></ul></li><li><a href="module-persistence.html">persistence</a></li></ul><h3>Global</h3><ul><li><a href="global.html#callSaltmine">callSaltmine</a></li><li><a href="global.html#decodeId">decodeId</a></li><li><a href="global.html#encodeId">encodeId</a></li><li><a href="global.html#fromBase64">fromBase64</a></li><li><a href="global.html#generateNewReadwriteKeypair">generateNewReadwriteKeypair</a></li><li><a href="global.html#generateReadonlyKeypair">generateReadonlyKeypair</a></li><li><a href="global.html#getLocalEntropy">getLocalEntropy</a></li><li><a href="global.html#getRegisteredSalt">getRegisteredSalt</a></li><li><a href="global.html#getRemoteEntropy">getRemoteEntropy</a></li><li><a href="global.html#pwDec">pwDec</a></li><li><a href="global.html#pwEnc">pwEnc</a></li><li><a href="global.html#pwHash">pwHash</a></li><li><a href="global.html#randomBytes">randomBytes</a></li><li><a href="global.html#regenerateReadwriteKeypair">regenerateReadwriteKeypair</a></li><li><a href="global.html#registerSalt">registerSalt</a></li><li><a href="global.html#resolverUrl">resolverUrl</a></li><li><a href="global.html#toBase64">toBase64</a></li><li><a href="global.html#verify">verify</a></li><li><a href="global.html#XorUint8Array">XorUint8Array</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">dpki-ultralite/util.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/* eslint-disable */

const _sodium = require('libsodium-wrappers-sumo')
const msgpack = require('msgpack-lite')

const NONCEBYTES = 24
const SALTBYTES = 16

/**
 * Output `count` random bytes
 * @example
 * const bytes = sodium.random.bytes(32)
 *
 * @param {number} count - number of random bytes to output
 * @return {Buffer}
 */
function randomBytes (count) {
  return new Promise((resolve, reject) => {
    _sodium.ready.then((_) => {
      resolve(_sodium.randombytes_buf(count))
      reject('failure reason') // rejected
    })
  })
}

exports.randomBytes = randomBytes
/**
 * using base64url encoding (https://tools.ietf.org/html/rfc4648#section-5)
 * Generate an identity string with a pair of public keys
 * @param {Buffer} signPub - singing public key
 * @param {Buffer} encPub - encryption public key
 * @return {string} - the base64url encoded identity (with checksum)
 */
function encodeId (signPub, encPub) {
  return new Promise((resolve, reject) => {
    _sodium.ready.then((_) => {
      resolve(_sodium.to_base64(new Uint8Array([...signPub, ...encPub])))
      reject('failure reason') // rejected
    })
  })
}

exports.encodeId = encodeId

/**
 * using base64url encoding (https://tools.ietf.org/html/rfc4648#section-5)
 * break an identity string up into a pair of public keys
 * @param {string} id - the base64url encoded identity string
 * @return {object} - { signPub: Buffer, encPub: Buffer }
 */
function decodeId (id) {
  return new Promise((resolve, reject) => {
    _sodium.ready.then((sodium) => {
      const tmp = _sodium.from_base64(id)
      resolve({
        signPub: tmp.slice(0, 32),
        encPub: tmp.slice(32, 64)
      })
      reject('failure reason')
    })
  })
}

exports.decodeId = decodeId

/**
 * verify a signature given the original data, and the signer's identity string
 * @param {Buffer} signature - the binary signature
 * @param {Buffer} data - the binary data to verify
 * @param {string} signerId - the signer's public identity string
 */
function verify (signature, data, signerId) {
  return new Promise((resolve, reject) => {
    decodeId(signerId).then(pw => {
      const signPub = pw.signPub
      _sodium.ready.then((sodium) => {
        resolve(_sodium.crypto_sign_verify_detached(signature, data, signPub))
        reject('failure reason')
      })
    })
  })
}
exports.verify = verify
/**
 * simplify the api for generating a password hash with our set parameters
 * @param {Buffer} pass - the password buffer to hash
 * @param {Buffer} [salt] - if specified, hash with this salt (otherwise random)
 * @return {object} - { salt: Buffer, hash: Buffer }
 */
function pwHash (pass, salt) {
  return new Promise((resolve, reject) => {
    _sodium.ready.then((_) => {
      const opt = {
        opslimit: _sodium.crypto_pwhash_OPSLIMIT_MODERATE,
        memlimit: _sodium.crypto_pwhash_MEMLIMIT_MODERATE,
        algorithm: _sodium.crypto_pwhash_ALG_ARGON2ID13,
        keyLength: 32
      }

      if (salt) {
        opt.salt = salt
      }

      if (!opt.salt) {
        opt.salt = _sodium.randombytes_buf(SALTBYTES)
      }
      let derivedKey = _sodium.crypto_pwhash(
        opt.keyLength, pass, opt.salt,
        opt.opslimit, opt.memlimit, opt.algorithm)
      resolve({
        salt: opt.salt,
        hash: derivedKey
      })
      reject('failure reason')
    })
  })
}
exports.pwHash = pwHash

/**
 * Helper for encrypting a buffer with a pwhash-ed passphrase
 * @param {Buffer} data
 * @param {string} passphrase
 * @return {Buffer} - the encrypted data
 */
function pwEnc (data, passphrase, adata) {
  return new Promise((resolve, reject) => {
    _sodium.ready.then((_) => {
      pwHash(passphrase).then(pw => {
        const salt = pw.salt
        const secret = pw.hash
        const nonce = _sodium.randombytes_buf(NONCEBYTES)
        let ciphertext = _sodium.crypto_aead_xchacha20poly1305_ietf_encrypt(data, adata || null, null, nonce, secret)

        resolve(msgpack.encode({
          salt,
          nonce,
          cipher: ciphertext
        }))
        reject('failure reason')
      })
    })
  })
}
exports.pwEnc = pwEnc

/**
 * Helper for decrypting a buffer with a pwhash-ed passphrase
 * @param {Buffer} data
 * @param {string} passphrase
 * @return {Buffer} - the decrypted data
 */
function pwDec (data, passphrase, adata) {
  data = msgpack.decode(data)
  return new Promise((resolve, reject) => {
    pwHash(passphrase, data.salt).then(pw => {
      const secret = pw.hash
      _sodium.ready.then((_) => {
        resolve(_sodium.crypto_aead_xchacha20poly1305_ietf_decrypt(
          null, data.cipher, adata || null, data.nonce, secret))
        reject('failure reason') // rejected
      })
    })
  })
}

exports.pwDec = pwDec

/**
 * Convert a buffer to a base64 encoded string.
 * Uses the URL safe no padding option
 *
 * @param      {Buffer}  buffer  The data to encode
 * @return     {string}  base64 encoded string
 */
function toBase64 (buffer) {
  return _sodium.ready.then((_) => {
    return _sodium.to_base64(
      buffer,
      _sodium.base64_variants.URLSAFE_NO_PADDING
    )
  })
}

exports.toBase64 = toBase64

/**
 * Convert a base64 encoded string to a buffer
 * Uses the URL safe no padding option
 *
 * @param      {string}  str  The base64 encoded string
 * @return     {string}  base64 encoded string
 */
function fromBase64 (str) {
  return _sodium.ready.then((_) => {
    return _sodium.from_base64(
      str,
      _sodium.base64_variants.URLSAFE_NO_PADDING
    )
  })
}

exports.fromBase64 = fromBase64
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Wed Mar 06 2019 12:37:28 GMT+1100 (AEDT) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>


</body>
</html>
